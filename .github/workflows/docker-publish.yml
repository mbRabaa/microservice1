name: CI/CD ComplÃ¨te - Analyse, DÃ©ploiement, Tests

on:
  push:
    branches: [ main ]

env:
  # Configuration globale
  SONAR_HOST_URL: http://localhost:9000
  K3S_VERSION: v1.26.5+k3s1
  TERRAFORM_VERSION: 1.5.5
  NAMESPACE: microservice

jobs:
  #############################################
  ### JOB 1 : VÃ‰RIFICATION ET TESTS UNITAIRE
  #############################################
  verification:
    name: "1. âœ… VÃ©rification du Code"
    runs-on: ubuntu-latest
    
    steps:
      # Ã‰tape 1.1 - RÃ©cupÃ©ration du code source
      - name: "1.1 ğŸ›ï¸ Checkout du code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour l'analyse SonarQube

      # Ã‰tape 1.2 - Installation des dÃ©pendances
      - name: "1.2 ğŸ“¦ Installer les dÃ©pendances"
        run: npm install

      # Ã‰tape 1.3 - ExÃ©cution des tests unitaires
      - name: "1.3 ğŸ§ª ExÃ©cuter les tests"
        run: npm test

  #############################################
  ### JOB 2 : ANALYSE QUALITÃ‰ AVEC SONARQUBE
  #############################################
  quality-analysis:
    name: "2. ğŸ” Analyse QualitÃ©"
    needs: verification  # DÃ©pend des tests unitaires
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # Ã‰tape 2.1 - DÃ©marrage de SonarQube
      - name: "2.1 ğŸ³ DÃ©marrer SonarQube"
        run: |
          docker run -d \
            --name sonarqube \
            -p 9000:9000 \
            -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
            sonarqube:9.9.1-community
          timeout 300 bash -c 'while ! curl -sSf ${{ env.SONAR_HOST_URL }}/api/system/status | grep -q "\"status\":\"UP\""; do
            sleep 10
            echo "En attente du dÃ©marrage..."
          done'

      # Ã‰tape 2.2 - GÃ©nÃ©ration du token
      - name: "2.2 ğŸ”‘ GÃ©nÃ©rer token SonarQube"
        run: |
          SONAR_TOKEN=$(curl -sS -u admin:admin \
            -X POST "${{ env.SONAR_HOST_URL }}/api/user_tokens/generate" \
            -d "name=github-action-$(date +%s)" \
            | jq -r '.token')
          echo "SONAR_TOKEN=$SONAR_TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$SONAR_TOKEN"

      # Ã‰tape 2.3 - Analyse du code
      - name: "2.3 ğŸ” ExÃ©cuter analyse SonarQube"
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

      # Ã‰tape 2.4 - Nettoyage
      - name: "2.4 ğŸ§¹ Nettoyer"
        if: always()
        run: docker rm -f sonarqube || true

  #############################################
  ### JOB 3 : DÃ‰PLOIEMENT TERRAFORM
  #############################################
  terraform-deploy:
    name: "3. ğŸš€ DÃ©ploiement Terraform"
    needs: quality-analysis  # DÃ©pend de l'analyse qualitÃ©
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      # Ã‰tape 3.1 - Authentification Docker
      - name: "3.1 ğŸ” Login Docker Hub"
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # Ã‰tape 3.2 - Build de l'image Docker
      - name: "3.2 ğŸ—ï¸ Build Docker"
        run: |
          docker build \
            -t ${{ secrets.DOCKER_USERNAME }}/gestion-trajet:${{ github.sha }} \
            -t ${{ secrets.DOCKER_USERNAME }}/gestion-trajet:latest \
            .

      # Ã‰tape 3.3 - Push de l'image
      - name: "3.3 ğŸš€ Push Docker"
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/gestion-trajet:${{ github.sha }}
          docker push ${{ secrets.DOCKER_USERNAME }}/gestion-trajet:latest

      # Ã‰tape 3.4 - Installation de K3s
      - name: "3.4 ğŸ–¥ï¸ Installer K3s"
        run: |
          curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=${{ env.K3S_VERSION }} sh -
          sudo chmod 644 /etc/rancher/k3s/k3s.yaml

      # Ã‰tape 3.5 - Configuration de kubectl
      - name: "3.5 âš™ï¸ Configurer kubectl"
        run: |
          mkdir -p $HOME/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
          sudo chown $(id -u):$(id -g) $HOME/.kube/config

      # Ã‰tape 3.6 - Installation de Terraform
      - name: "3.6 âš™ï¸ Installer Terraform"
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      # Ã‰tape 3.7 - DÃ©ploiement Terraform
      - name: "3.7 ğŸŒ DÃ©ployer infrastructure"
        working-directory: ./infra
        env:
          TF_VAR_docker_username: ${{ secrets.DOCKER_USERNAME }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
          TF_VAR_image_tag: ${{ github.sha }}
        run: |
          terraform init
          terraform validate
          terraform apply -auto-approve

      # Ã‰tape 3.8 - RÃ©cupÃ©ration de l'URL
      - name: "3.8 ğŸ“Œ RÃ©cupÃ©rer URL service"
        id: get-service-url
        working-directory: ./infra
        run: |
          echo "service_url=$(terraform output -raw service_url)" >> $GITHUB_OUTPUT

  #############################################
  ### JOB 4 : TESTS D'INTÃ‰GRATION
  #############################################
  integration-tests:
    name: "4. ğŸ”— Tests d'IntÃ©gration"
    needs: terraform-deploy  # NÃ©cessite l'URL du service
    runs-on: ubuntu-latest
    
    steps:
      # Ã‰tape 4.1 - Installation des dÃ©pendances
      - name: "4.1 ğŸ“¦ Installer dÃ©pendances"
        run: npm install

      # Ã‰tape 4.2 - Test de santÃ©
      - name: "4.2 ğŸ©º Tester santÃ© API"
        env:
          SERVICE_URL: ${{ needs.terraform-deploy.outputs.service_url }}
        run: |
          echo "Test du endpoint /health sur $SERVICE_URL"
          curl -sSf "$SERVICE_URL/health" || exit 1

      # Ã‰tape 4.3 - Tests fonctionnels
      - name: "4.3 ğŸ§ª ExÃ©cuter tests complets"
        run: npm run test:integration

      # Ã‰tape 4.4 - Archivage des rÃ©sultats
      - name: "4.4 ğŸ“¦ Sauvegarder rÃ©sultats"
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            coverage/
            test-results.xml