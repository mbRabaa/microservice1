name: CI/CD ComplÃ¨te - VÃ©rification, Analyse, Tests, DÃ©ploiement

on:
  push:
    branches: [ main ]

env:
  # Configuration globale
  SONAR_HOST_URL: http://localhost:9000
  SONAR_PROJECT_KEY: gestion-trajet-app
  K3S_VERSION: v1.26.5+k3s1
  TERRAFORM_VERSION: 1.5.5
  NAMESPACE: microservice
  DOCKER_REGISTRY: docker.io

jobs:
  #############################################
  ### JOB 1 : INSTALLATION ET TESTS UNITAIRE
  #############################################
  install-and-test:
    name: "1. ðŸ“¦ Installation & Tests Unitaires"
    runs-on: ubuntu-latest
    
    steps:
      - name: "1.1 ðŸ›Žï¸ Checkout du code"
        uses: actions/checkout@v4

      - name: "1.2 ðŸ“¦ Installer les dÃ©pendances"
        run: npm ci

      - name: "1.3 ðŸ§ª ExÃ©cuter les tests unitaires"
        run: npm test

  #############################################
  ### JOB 2 : ANALYSE QUALITÃ‰ AVEC SONARQUBE
  #############################################
  sonarqube-analysis:
    name: "2. ðŸ” Analyse QualitÃ©"
    needs: install-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: "2.1 ðŸ›Žï¸ Checkout du code (full history)"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "2.2 ðŸ³ DÃ©marrer SonarQube"
        run: |
          docker run -d \
            --name sonarqube \
            -p 9000:9000 \
            -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
            sonarqube:9.9.1-community
          timeout 300 bash -c 'while ! curl -sSf ${{ env.SONAR_HOST_URL }}/api/system/status | grep -q "\"status\":\"UP\""; do
            sleep 10
            echo "En attente du dÃ©marrage..."
          done'

      - name: "2.3 ðŸ”‘ GÃ©nÃ©rer token SonarQube"
        run: |
          SONAR_TOKEN=$(curl -sS -u admin:admin \
            -X POST "${{ env.SONAR_HOST_URL }}/api/user_tokens/generate" \
            -d "name=github-action-$(date +%s)" \
            | jq -r '.token')
          echo "SONAR_TOKEN=$SONAR_TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$SONAR_TOKEN"

      - name: "2.4 ðŸ” ExÃ©cuter analyse SonarQube"
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }}
            -Dsonar.projectName="Gestion Trajet"
            -Dsonar.sources=.
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.login=${{ env.SONAR_TOKEN }}

      - name: "2.5 ðŸ§¹ Nettoyer SonarQube"
        if: always()
        run: docker rm -f sonarqube || true

  #############################################
  ### JOB 3 : TESTS D'INTÃ‰GRATION (OPTIMISÃ‰)
  #############################################
  integration-tests:
    name: "3. ðŸ”— Tests d'IntÃ©gration"
    needs: sonarqube-analysis
    runs-on: ubuntu-latest
    
    steps:
      # Ã‰tape 3.1 - RÃ©cupÃ©ration du code source
      - name: "3.1 ðŸ›Žï¸ Checkout du code"
        uses: actions/checkout@v4

      # Ã‰tape 3.2 - Configuration de l'environnement Docker
      - name: "3.2 ðŸ³ Configurer Docker"
        uses: docker/setup-buildx-action@v2

      # Ã‰tape 3.3 - Installation des dÃ©pendances Node.js
      - name: "3.3 ðŸ“¦ Installer les dÃ©pendances"
        run: npm ci

      # Ã‰tape 3.4 - DÃ©marrage de PostgreSQL pour les tests
      - name: "3.4 ðŸ³ DÃ©marrer PostgreSQL"
        run: |
          # Lancement du conteneur PostgreSQL avec vÃ©rification de santÃ©
          docker run -d --name test-db \
            -e POSTGRES_USER=testuser \
            -e POSTGRES_PASSWORD=testpass \
            -e POSTGRES_DB=testdb \
            -p 5432:5432 \
            --health-cmd "pg_isready -U testuser -d testdb" \
            --health-interval 10s \
            --health-timeout 5s \
            --health-retries 5 \
            postgres:13

          # Attente active que PostgreSQL soit prÃªt (timeout aprÃ¨s 2 minutes)
          echo "âŒ› VÃ©rification de la disponibilitÃ© de PostgreSQL..."
          timeout 120s bash -c 'until docker exec test-db pg_isready -U testuser -d testdb; do sleep 2; done'
          echo "âœ… PostgreSQL est opÃ©rationnel"

      # Ã‰tape 3.5 - ExÃ©cution des tests d'intÃ©gration
      - name: "3.5 ðŸ§ª ExÃ©cuter les tests d'intÃ©gration"
        run: npm run test:integration
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: testuser
          DB_PASSWORD: testpass
          DB_NAME: testdb
          NODE_ENV: test
        # Ces variables sont injectÃ©es dans l'application Node.js

      # Ã‰tape 3.6 - Nettoyage des ressources (toujours exÃ©cutÃ©e)
      - name: "3.6 ðŸ§¹ Nettoyer les ressources"
        if: always()
        run: |
          docker rm -f test-db || true
          echo "ðŸ§½ Nettoyage des conteneurs terminÃ©"

  #############################################
  ### JOB 4 : DÃ‰PLOIEMENT TERRAFORM
  #############################################
  terraform-deploy:
    name: "4. ðŸš€ DÃ©ploiement Terraform"
    needs: integration-tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: "4.1 ðŸ” Authentification Docker Hub"
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: "4.2 ðŸ—ï¸ Build Docker"
        run: |
          docker build \
            -t ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:${{ github.sha }} \
            -t ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:latest \
            .

      - name: "4.3 ðŸš€ Push Docker"
        run: |
          docker push ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:${{ github.sha }}
          docker push ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:latest

      - name: "4.4 ðŸ–¥ï¸ Installer K3s"
        run: |
          curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=${{ env.K3S_VERSION }} sh -
          sudo chmod 644 /etc/rancher/k3s/k3s.yaml

      - name: "4.5 âš™ï¸ Configurer kubectl"
        run: |
          mkdir -p $HOME/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
          sudo chown $(id -u):$(id -g) $HOME/.kube/config

      - name: "4.6 âš™ï¸ Installer Terraform"
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: "4.7 ðŸŒ DÃ©ployer infrastructure"
        working-directory: ./infra
        env:
          TF_VAR_docker_username: ${{ secrets.DOCKER_USERNAME }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
          TF_VAR_image_tag: ${{ github.sha }}
        run: |
          terraform init
          terraform validate
          terraform apply -auto-approve

      - name: "4.8 ðŸ” VÃ©rifier dÃ©ploiement"
        run: |
          kubectl get all -n ${{ env.NAMESPACE }} --request-timeout='5s' 2>/dev/null || true
          echo "Service URL: $(terraform -chdir=infra output -raw service_url)"