name: CI/CD - Pipeline DevOps avec Terraform

on:
  push:
    branches:
      - main

env:
  SONAR_HOST_URL: http://localhost:9000
  K3S_VERSION: v1.26.5+k3s1
  TERRAFORM_VERSION: 1.5.5
  NAMESPACE: microservice
  DOCKER_REGISTRY: docker.io
  NODE_VERSION: 20
  # Monitoring
  PROMETHEUS_URL: http://prometheus:9090
  GRAFANA_URL: http://grafana:3000
  
  # Email
  YOUR_EMAIL: elmbarkirabea@gmail.com # ‚Üê Remplacez par votre email
  EMAIL_FROM: "GitHub Actions <actions@github.com>"


jobs:
  setup-and-test:
    name: "1. Installation et Tests"
    runs-on: ubuntu-latest
    
    steps:
      - name: "üõéÔ∏è Checkout du code"
        uses: actions/checkout@v4

      - name: "‚éî Configurer Node.js"
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "üì¶ Installer les d√©pendances"
        run: npm ci

      - name: "üß™ Tests Unitaires"
        run: npm run test:unit
        env:
          NODE_ENV: test

      - name: "üîó Tests d'Int√©gration"
        run: npm run test:integration
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: testuser
          DB_PASSWORD: testpass
          NODE_ENV: test

      - name: "üõ†Ô∏è Build de l'application"
        run: npm run build

  sonarqube-analysis:
    name: "2. Analyse SonarQube"
    needs: setup-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: "üõéÔ∏è Checkout du code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "üê≥ D√©marrer SonarQube"
        run: |
          docker run -d \
            --name sonarqube \
            -p 9000:9000 \
            -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
            sonarqube:9.9.1-community
          timeout 300 bash -c 'while ! curl -sSf ${{ env.SONAR_HOST_URL }}/api/system/status | grep -q "\"status\":\"UP\""; do
            sleep 10
            echo "En attente du d√©marrage..."
          done'

      - name: "üîë G√©n√©rer token SonarQube"
        run: |
          SONAR_TOKEN=$(curl -sS -u admin:admin \
            -X POST "${{ env.SONAR_HOST_URL }}/api/user_tokens/generate" \
            -d "name=github-action-$(date +%s)" \
            | jq -r '.token')
          echo "SONAR_TOKEN=$SONAR_TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$SONAR_TOKEN"

      - name: "üîç Ex√©cuter analyse SonarQube"
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=gestion-trajet-app
            -Dsonar.sources=src
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

      - name: "üßπ Nettoyer SonarQube"
        if: always()
        run: docker rm -f sonarqube || true

  docker-deploy:
    name: "3. D√©ploiement Docker et Kubernetes"
    needs: sonarqube-analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: "üõéÔ∏è Checkout du code"
        uses: actions/checkout@v4

      - name: "üîê Login Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: "üèóÔ∏è Build Docker"
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:latest

      - name: "üñ•Ô∏è Installer K3s"
        run: |
          curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=${{ env.K3S_VERSION }} sh -
          sudo chmod 644 /etc/rancher/k3s/k3s.yaml

      - name: "‚öôÔ∏è Configurer kubectl"
        run: |
          mkdir -p $HOME/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
          sudo chown $(id -u):$(id -g) $HOME/.kube/config

      - name: "‚öôÔ∏è Installer Terraform"
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: "üöÄ D√©ployer avec Terraform"
        working-directory: ./infra
        env:
          TF_VAR_docker_username: ${{ secrets.DOCKER_USERNAME }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
          TF_VAR_image_tag: ${{ github.sha }}
        run: |
          terraform init
          terraform validate
          terraform apply -auto-approve

      - name: "üîç V√©rifier le d√©ploiement"
        run: |
          kubectl get all -n ${{ env.NAMESPACE }}
          echo "Service URL: $(terraform -chdir=infra output -raw service_url)"

          monitoring-check:
            name: "6. V√©rification Monitoring"
            needs: deploy-prod
            runs-on: ubuntu-latest
            
            steps:
              - name: "üìä V√©rifier Prometheus"
                run: |
                  # V√©rifier que le service est up
                  curl -s "${{ env.PROMETHEUS_URL }}/api/v1/targets" | \
                    jq -e '.data.activeTargets[] | select(.labels.job=="gestion-trajet" and .health=="up")'
                  
                  # V√©rifier des m√©triques sp√©cifiques
                  curl -s "${{ env.PROMETHEUS_URL }}/api/v1/query?query=up{job='gestion-trajet'}" | \
                    jq -e '.data.result[0].value[1] == "1"'
        
              - name: "üìà V√©rifier Grafana"
                run: |
                  # V√©rifier que le dashboard existe
                  curl -s -H "Authorization: Bearer ${{ secrets.GRAFANA_API_KEY }}" \
                    "${{ env.GRAFANA_URL }}/api/dashboards/uid/gestion-trajet-dashboard" | \
                    jq -e '.dashboard'
                  
                  # V√©rifier la sant√© de Grafana
                  curl -s "${{ env.GRAFANA_URL }}/api/health" | \
                    jq -e '.database == "ok"'
        
          notify:
            name: "üìß Notifications Finales"
            needs: [deploy-prod, monitoring-check]
            runs-on: ubuntu-latest
            
            steps:
              - name: "üåê R√©cup√©rer l'URL de production"
                id: prod-url
                working-directory: ./infra
                run: |
                  echo "PROD_URL=$(terraform output -raw service_url)" >> $GITHUB_OUTPUT
        
              - name: "üìß Envoyer rapport complet"
                uses: dawidd6/action-send-mail@v3
                with:
                  server_address: smtp.gmail.com
                  server_port: 465
                  username: ${{ secrets.EMAIL_USERNAME }}
                  password: ${{ secrets.EMAIL_PASSWORD }}
                  from: ${{ env.EMAIL_FROM }}
                  to: ${{ env.YOUR_EMAIL }}
                  subject: "Rapport de d√©ploiement - ${{ github.repository }}"
                  body: |
                    D√©ploiement termin√© avec statut: ${{ job.status }}
        
                    D√©tails :
                    - Application: ${{ steps.prod-url.outputs.PROD_URL }}
                    - Commit: ${{ github.sha }}
                    - Date: $(date)
                    - Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        
                    Dashboard Grafana: ${{ env.GRAFANA_URL }}/d/gestion-trajet-dashboard