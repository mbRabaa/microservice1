name: CI/CD - Pipeline DevOps & K3s Deployment

on:
  push:
    branches:
      - main

jobs:
  sonarqube-analysis:
    name: Analyse SonarQube
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # Solution alternative sans service container
    steps:
      - name: ğŸ›ï¸ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ³ DÃ©marrer SonarQube dans un conteneur
        run: |
          docker run -d \
            --name sonarqube \
            -p 9000:9000 \
            -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
            -e SONAR_WEB_JAVAOPTS="-Xmx1g -Xms512m" \
            -e SONAR_SEARCH_JAVAOPTS="-Xmx512m -Xms256m" \
            --memory 3g \
            --cpus 2 \
            sonarqube:9.9.1-community
          
          echo "SonarQube container dÃ©marrÃ©, attente du dÃ©marrage complet..."
          timeout 600 bash -c 'while ! curl -sSf http://localhost:9000/api/system/status | grep -q "\"status\":\"UP\""; do
            sleep 10
            echo "En attente du dÃ©marrage de SonarQube..."
          done'
          echo "SonarQube est prÃªt!"

      - name: ğŸ“¦ Installer les dÃ©pendances
        run: npm install

      - name: ğŸ§ª ExÃ©cuter les tests
        run: npm test

      - name: ğŸ” ExÃ©cuter l'analyse SonarQube
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://localhost:9000
          SONAR_SCANNER_OPTS: "-Xmx1024m"

      - name: ğŸš¦ VÃ©rifier Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1
        timeout-minutes: 10
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: ğŸ§¹ Nettoyer le conteneur SonarQube
        if: always()
        run: |
          docker stop sonarqube || true
          docker rm sonarqube || true

  build-and-deploy:
    name: Build et DÃ©ploiement
    needs: sonarqube-analysis
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ” Login Docker Hub
        run: echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: ğŸ—ï¸ Build Docker
        run: |
          docker build \
            -t ${{ secrets.DOCKER_USERNAME }}/gestion-trajet:latest \
            -t ${{ secrets.DOCKER_USERNAME }}/gestion-trajet:${{ github.sha }} \
            .

      - name: ğŸš€ Push Docker
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/gestion-trajet:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/gestion-trajet:${{ github.sha }}

      - name: ğŸ–¥ï¸ Installer K3s
        run: |
          curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=v1.26.5+k3s1 sh -
          sudo chmod 644 /etc/rancher/k3s/k3s.yaml

      - name: âš™ï¸ Configurer kubectl
        run: |
          mkdir -p $HOME/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
          sudo chown $(id -u):$(id -g) $HOME/.kube/config
          sed -i 's/127.0.0.1/localhost/g' $HOME/.kube/config

      - name: ğŸš€ DÃ©ployer sur K3s
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/ingress.yaml
          kubectl rollout status deployment/gestion-trajet --timeout=300s

      - name: ğŸ” VÃ©rifier le dÃ©ploiement
        run: |
          kubectl get all -n default
          kubectl get ingress -n default