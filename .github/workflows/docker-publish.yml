name: CI/CD - Pipeline DevOps complet

on:
  push:
    branches:
      - main

env:
  # Configurations de base
  NODE_VERSION: 20
  DOCKER_REGISTRY: docker.io
  NAMESPACE: microservice
  TERRAFORM_VERSION: 1.5.5
  K3S_VERSION: v1.26.5+k3s1
  
  # Monitoring
  PROMETHEUS_URL: http://prometheus-server.monitoring.svc.cluster.local:9090
  GRAFANA_URL: http://grafana-service.monitoring.svc.cluster.local:3000
  GRAFANA_DASHBOARD_UID: gestion-trajet-dashboard
  
  # SonarQube
  SONAR_HOST_URL: http://localhost:9000
  
  # Email
  YOUR_EMAIL: elmbarkirabea@gmail.com
  EMAIL_FROM: "GitHub Actions <actions@github.com>"

jobs:
  # ============ √âTAPE 1: TESTS ============
  setup-and-test:
    name: "1. Tests et Build"
    runs-on: ubuntu-latest
    
    steps:
      - name: "üõéÔ∏è Checkout du code"
        uses: actions/checkout@v4.1.1

      - name: "‚éî Configurer Node.js"
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "üì¶ Installer les d√©pendances"
        run: npm ci

      - name: "üß™ Tests Unitaires"
        run: npm run test:unit
        env:
          NODE_ENV: test

      - name: "üìä G√©n√©rer le rapport de couverture"
        run: |
          mkdir -p coverage
          npm run coverage

      - name: "üîó Tests d'int√©gration"
        run: npm run test:integration
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: testuser
          DB_PASSWORD: testpass
          NODE_ENV: test

      - name: "üõ†Ô∏è Build de l'application"
        run: npm run build

  # ============ √âTAPE 2: ANALYSE QUALIT√â ============
  sonarqube-analysis:
    name: "2. Analyse SonarQube"
    needs: setup-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0

      - name: "üê≥ D√©marrer SonarQube"
        run: |
          docker run -d \
            --name sonarqube \
            -p 9000:9000 \
            -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
            sonarqube:9.9.1-community
          timeout 300 bash -c 'while ! curl -sSf ${{ env.SONAR_HOST_URL }}/api/system/status | grep -q "\"status\":\"UP\""; do
            sleep 10
            echo "En attente du d√©marrage..."
          done'

      - name: "üîë G√©n√©rer token SonarQube"
        run: |
          SONAR_TOKEN=$(curl -sS -u admin:admin \
            -X POST "${{ env.SONAR_HOST_URL }}/api/user_tokens/generate" \
            -d "name=github-action-$(date +%s)" \
            | jq -r '.token')
          echo "SONAR_TOKEN=$SONAR_TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$SONAR_TOKEN"

      - name: "üîç Ex√©cuter analyse SonarQube"
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=gestion-trajet-app
            -Dsonar.sources=src
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.tests=test
            -Dsonar.test.inclusions=test/**/*.test.js

      - name: "üßπ Nettoyer SonarQube"
        if: always()
        run: docker rm -f sonarqube || true

  # ============ √âTAPE 3: D√âPLOIEMENT ============
  docker-deploy:
    name: "3. D√©ploiement Docker/K8s"
    needs: sonarqube-analysis
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4.1.1

      - name: "üîê Login Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: "üèóÔ∏è Build et Push Docker"
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:latest

      - name: "üñ•Ô∏è Installer et Configurer K3s"
        run: |
          # Installer K3s
          curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=${{ env.K3S_VERSION }} sh -
          
          # Configurer kubectl
          mkdir -p $HOME/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
          sudo chown $(id -u):$(id -g) $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config
          echo "KUBECONFIG=$HOME/.kube/config" >> $GITHUB_ENV
          
          # V√©rifier la connexion
          kubectl cluster-info
          kubectl get nodes

      - name: "‚öôÔ∏è Installer Terraform"
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: "üöÄ D√©ployer l'infrastructure"
        working-directory: ./infra
        env:
          TF_VAR_docker_username: ${{ secrets.DOCKER_USERNAME }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
          TF_VAR_image_tag: ${{ github.sha }}
        run: |
          terraform init
          terraform validate
          terraform apply -auto-approve

      - name: "üîç V√©rifier le d√©ploiement"
        run: |
          kubectl get pods,svc,deploy -n ${{ env.NAMESPACE }}
          echo "Service URL: $(terraform -chdir=infra output -raw service_url)"

  # ============ √âTAPE 4: MONITORING ============
  monitoring-check:
    name: "4. Configuration Monitoring"
    needs: docker-deploy
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: "üõ†Ô∏è Installer Helm"
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: "üîç V√©rifier la connexion Kubernetes"
        run: |
          kubectl cluster-info
          kubectl get ns

      - name: "üì¶ Installer Prometheus et Grafana"
        run: |
          # Cr√©er le namespace monitoring
          kubectl create namespace monitoring || true
          
          # Ajouter les repos Helm
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update
          
          # Installer Prometheus
          helm upgrade --install prometheus prometheus-community/prometheus \
            --namespace monitoring \
            --set server.service.type=ClusterIP \
            --set server.persistentVolume.enabled=false \
            --set alertmanager.enabled=false
          
          # Installer Grafana
          helm upgrade --install grafana grafana/grafana \
            --namespace monitoring \
            --set service.type=ClusterIP \
            --set persistence.enabled=false \
            --set adminPassword=admin

      - name: "‚öôÔ∏è Configurer Prometheus pour le microservice"
        run: |
          # Cr√©er un ServiceMonitor
          cat <<EOF | kubectl apply -f -
          apiVersion: monitoring.coreos.com/v1
          kind: ServiceMonitor
          metadata:
            name: gestion-trajet-monitor
            namespace: monitoring
            labels:
              release: prometheus
          spec:
            selector:
              matchLabels:
                app: gestion-trajet
            endpoints:
            - port: http
              path: /metrics
              interval: 15s
          EOF
          
          # Red√©marrer Prometheus
          kubectl rollout restart deployment prometheus-server -n monitoring

      - name: "üìä Configurer Grafana"
        env:
          GRAFANA_ADMIN_PASSWORD: admin
        run: |
          # Attendre que Grafana soit pr√™t
          kubectl wait --for=condition=ready pod -n monitoring -l app.kubernetes.io/name=grafana --timeout=120s
          
          # Configurer le port-forward
          kubectl port-forward svc/grafana 3000:3000 -n monitoring --address=0.0.0.0 &
          sleep 10
          
          # Cr√©er un API key
          GRAFANA_KEY=$(curl -s -X POST -H "Content-Type: application/json" \
            -d '{"name":"github-action","role":"Admin"}' \
            http://admin:$GRAFANA_ADMIN_PASSWORD@localhost:3000/api/auth/keys | jq -r '.key')
          
          echo "GRAFANA_API_KEY=$GRAFANA_KEY" >> $GITHUB_ENV
          echo "::add-mask::$GRAFANA_KEY"
          
          # Importer un dashboard exemple
          cat <<EOF > dashboard.json
          {
            "dashboard": {
              "id": null,
              "uid": "${{ env.GRAFANA_DASHBOARD_UID }}",
              "title": "Microservice Monitoring",
              "panels": [],
              "schemaVersion": 26
            },
            "folderId": 0,
            "overwrite": true
          }
          EOF
          
          curl -s -X POST \
            -H "Authorization: Bearer $GRAFANA_KEY" \
            -H "Content-Type: application/json" \
            -d @dashboard.json \
            http://localhost:3000/api/dashboards/db

      - name: "‚úÖ V√©rifier le monitoring"
        run: |
          # V√©rifier Prometheus
          kubectl port-forward svc/prometheus-server 9090:9090 -n monitoring --address=0.0.0.0 &
          sleep 5
          curl -s http://localhost:9090/api/v1/targets | \
            jq -e '.data.activeTargets[] | select(.labels.job=="gestion-trajet" and .health=="up")' || \
            echo "::warning::Target gestion-trajet non trouv√©e"
          
          # V√©rifier Grafana
          kubectl port-forward svc/grafana 3000:3000 -n monitoring --address=0.0.0.0 &
          sleep 5
          curl -s http://localhost:3000/api/health | jq -e '.database == "ok"'

  # ============ √âTAPE 5: NOTIFICATIONS ============
  notify:
    name: "5. Notifications Finales"
    needs: [docker-deploy, monitoring-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: "üåê R√©cup√©rer l'URL du service"
        id: get-url
        working-directory: ./infra
        run: |
          if [ -f "output.tf" ]; then
            echo "SERVICE_URL=$(terraform output -raw service_url)" >> $GITHUB_OUTPUT
          else
            echo "::warning::Fichier output.tf non trouv√©"
            echo "SERVICE_URL=non-disponible" >> $GITHUB_OUTPUT
          fi

      - name: "üìß Envoyer rapport complet"
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          from: ${{ env.EMAIL_FROM }}
          to: ${{ env.YOUR_EMAIL }}
          subject: "D√©ploiement termin√© - ${{ github.sha }}"
          body: |
            Statut: ${{ job.status }}
            
            D√©tails:
            - Service: ${{ steps.get-url.outputs.SERVICE_URL }}
            - Commit: ${{ github.sha }}
            - Date: $(date)
            
            Monitoring:
            - Prometheus: ${{ env.PROMETHEUS_URL }}
            - Grafana: ${{ env.GRAFANA_URL }}/d/${{ env.GRAFANA_DASHBOARD_UID }}
            
            Logs complets:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}