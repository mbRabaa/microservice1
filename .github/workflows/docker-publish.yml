name: CI/CD Compl√®te - React + Terraform + K3s
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # Configuration globale
  SONAR_HOST_URL: http://localhost:9000  # URL locale pour SonarQube
  K3S_VERSION: v1.26.5+k3s1             # Version sp√©cifique de K3s
  TERRAFORM_VERSION: 1.5.5              # Version de Terraform
  NAMESPACE: microservice               # Namespace Kubernetes
  DOCKER_REGISTRY: docker.io            # Registry Docker

jobs:
  ##############################################
  ### JOB 1 - TESTS UNITAIRES AVEC VITEST ###
  ##############################################
  unit-tests:
    name: "1. üß™ Tests Unitaires (Vitest)"
    runs-on: ubuntu-latest
    
    steps:
      # √âtape 1.1 - R√©cup√©ration du code
      - name: "1.1 üõéÔ∏è Checkout du code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # N√©cessaire pour certains outils d'analyse

      # √âtape 1.2 - Installation des d√©pendances
      - name: "1.2 üì¶ Installer les d√©pendances"
        run: |
          npm ci  # Utilise package-lock.json pour une installation reproductible
          echo "D√©pendances install√©es avec succ√®s"

      # √âtape 1.3 - Ex√©cution des tests avec Vitest
      - name: "1.3 üî¨ Ex√©cuter tests (Vitest)"
        run: |
          echo "D√©but des tests unitaires avec Vitest..."
          npm test -- --coverage  # Ex√©cute Vitest avec rapport de couverture
          echo "Tests unitaires termin√©s"

      # √âtape 1.4 - Archivage des r√©sultats
      - name: "1.4 üì¶ Sauvegarder r√©sultats"
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            coverage/          # Rapport de couverture
            test-results.xml   # R√©sultats au format JUnit

  ##############################################
  ### JOB 2 - ANALYSE QUALIT√â AVEC SONARQUBE ###
  ##############################################
  sonarqube-analysis:
    name: "2. üîç Analyse SonarQube"
    needs: unit-tests  # D√©pend des tests unitaires
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout pour √©viter les blocages
    
    steps:
      # √âtape 2.1 - R√©cup√©ration du code
      - name: "2.1 üõéÔ∏è Checkout du code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # N√©cessaire pour l'analyse Sonar

      # √âtape 2.2 - D√©marrage du serveur SonarQube
      - name: "2.2 üê≥ D√©marrer SonarQube"
        run: |
          echo "D√©marrage du conteneur SonarQube..."
          docker run -d \
            --name sonarqube \
            -p 9000:9000 \
            -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
            --memory 2g \
            --cpus 2 \
            sonarqube:9.9.1-community
          
          # Attente du d√©marrage (5 minutes max)
          echo "Attente du d√©marrage de SonarQube..."
          timeout 300 bash -c 'while ! curl -sSf ${{ env.SONAR_HOST_URL }}/api/system/status | grep -q "\"status\":\"UP\""; do
            sleep 10
            echo "En attente..."
          done'
          echo "SonarQube est pr√™t!"

      # √âtape 2.3 - G√©n√©ration du token d'acc√®s
      - name: "2.3 üîë G√©n√©rer token SonarQube"
        id: sonar-token
        run: |
          echo "G√©n√©ration du token SonarQube..."
          SONAR_TOKEN=$(curl -sS -u admin:admin \
            -X POST "${{ env.SONAR_HOST_URL }}/api/user_tokens/generate" \
            -d "name=github-action-$(date +%s)" \
            | jq -r '.token')
          
          # S√©curisation du token
          echo "SONAR_TOKEN=$SONAR_TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$SONAR_TOKEN"
          echo "Token g√©n√©r√© et s√©curis√©"

      # √âtape 2.4 - Analyse du code
      - name: "2.4 üîç Ex√©cuter analyse SonarQube"
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
          SONAR_SCANNER_OPTS: "-Xmx1024m"
        with:
          args: >
            -Dsonar.projectKey=my-project
            -Dsonar.projectName=GestionTrajet

      # √âtape 2.5 - Nettoyage
      - name: "2.5 üßπ Nettoyer SonarQube"
        if: always()
        run: |
          echo "Nettoyage du conteneur SonarQube..."
          docker rm -f sonarqube || echo "Nettoyage d√©j√† effectu√©"

  ##############################################
  ### JOB 3 - BUILD ET D√âPLOIEMENT TERRAFORM ###
  ##############################################
  terraform-deploy:
    name: "3. üöÄ D√©ploiement Terraform"
    needs: sonarqube-analysis  # D√©pend de l'analyse Sonar
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      # √âtape 3.1 - R√©cup√©ration du code
      - name: "3.1 üõéÔ∏è Checkout du code"
        uses: actions/checkout@v4

      # √âtape 3.2 - Authentification Docker
      - name: "3.2 üîê Login Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
        env:
          DOCKER_REGISTRY: ${{ env.DOCKER_REGISTRY }}

      # √âtape 3.3 - Construction de l'image Docker
      - name: "3.3 üèóÔ∏è Build Docker"
        run: |
          echo "Construction de l'image Docker..."
          docker build \
            -t ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:${{ github.sha }} \
            -t ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:latest \
            .
          echo "Build Docker termin√©"

      # √âtape 3.4 - Envoi des images
      - name: "3.4 üöÄ Push Docker"
        run: |
          echo "Envoi des images Docker..."
          docker push ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:${{ github.sha }}
          docker push ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:latest
          echo "Push Docker termin√©"

      # √âtape 3.5 - Installation de K3s
      - name: "3.5 üñ•Ô∏è Installer K3s"
        run: |
          echo "Installation de K3s (Kubernetes l√©ger)..."
          curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=${{ env.K3S_VERSION }} sh -
          sudo chmod 644 /etc/rancher/k3s/k3s.yaml
          echo "K3s install√© avec succ√®s"

      # √âtape 3.6 - Configuration de kubectl
      - name: "3.6 ‚öôÔ∏è Configurer kubectl"
        run: |
          echo "Configuration de kubectl..."
          mkdir -p $HOME/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
          sudo chown $(id -u):$(id -g) $HOME/.kube/config
          
          # V√©rification de la connexion
          kubectl cluster-info
          echo "kubectl configur√©"

      # √âtape 3.7 - Installation de Terraform
      - name: "3.7 ‚öôÔ∏è Installer Terraform"
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      # √âtape 3.8 - D√©ploiement Terraform
      - name: "3.8 üåê D√©ployer avec Terraform"
        working-directory: ./infra
        env:
          TF_VAR_docker_username: ${{ secrets.DOCKER_USERNAME }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
          TF_VAR_image_tag: ${{ github.sha }}
          TF_VAR_namespace: ${{ env.NAMESPACE }}
        run: |
          echo "Initialisation de Terraform..."
          terraform init -input=false
          
          echo "Validation de la configuration..."
          terraform validate
          
          echo "Planification du d√©ploiement..."
          terraform plan -out=tfplan
          
          echo "Application des changements..."
          terraform apply -auto-approve tfplan
          echo "D√©ploiement Terraform termin√©"

      # √âtape 3.9 - V√©rification du d√©ploiement
      - name: "3.9 üîç V√©rifier d√©ploiement"
        run: |
          echo "V√©rification des ressources d√©ploy√©es..."
          kubectl get all -n ${{ env.NAMESPACE }} --request-timeout='5s' 2>/dev/null || true
          
          echo -e "\nURL du service d√©ploy√© :"
          terraform -chdir=infra output -raw service_url

      # √âtape 3.10 - Stockage de l'URL
      - name: "3.10 üìå Stocker l'URL du service"
        id: set-output
        working-directory: ./infra
        run: |
          echo "service_url=$(terraform output -raw service_url | tr -d '\n')" >> $GITHUB_OUTPUT
          echo "URL du service stock√©e pour les tests d'int√©gration"

  ##############################################
  ### JOB 4 - TESTS D'INT√âGRATION ###
  ##############################################
  integration-tests:
    name: "4. üîó Tests d'Int√©gration"
    needs: terraform-deploy  # N√©cessite l'URL du service d√©ploy√©
    runs-on: ubuntu-latest
    
    steps:
      # √âtape 4.1 - R√©cup√©ration du code
      - name: "4.1 üõéÔ∏è Checkout du code"
        uses: actions/checkout@v4

      # √âtape 4.2 - Installation des d√©pendances
      - name: "4.2 üì¶ Installer d√©pendances"
        run: |
          echo "Installation des d√©pendances de test..."
          npm install
          npm install -g newman  # Pour les tests API

      # √âtape 4.3 - Ex√©cution des tests
      - name: "4.3 üß™ Ex√©cuter tests"
        env:
          API_BASE_URL: ${{ needs.terraform-deploy.outputs.service_url }}
        run: |
          echo "D√©but des tests d'int√©gration sur $API_BASE_URL"
          
          # Test basique de sant√©
          echo "Test de sant√©..."
          curl -sSf "$API_BASE_URL/health" || exit 1
          
          # Exemple avec Newman (tests API)
          echo "Ex√©cution des tests API..."
          newman run tests/integration/api-tests.json \
            --env-var "base_url=$API_BASE_URL" \
            --reporters cli,junit \
            --reporter-junit-export test-results/integration.xml
          
          echo "Tests d'int√©gration termin√©s avec succ√®s"

      # √âtape 4.4 - Archivage des r√©sultats
      - name: "4.4 üì¶ Publier r√©sultats"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            test-results/
            coverage/

      # √âtape 4.5 - Notification visuelle
      - name: "4.5 ‚úÖ Afficher r√©sultat"
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "::notice::Tous les tests ont r√©ussi!"
          else
            echo "::error::Certains tests ont √©chou√©"
          fi