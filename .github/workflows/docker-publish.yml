name: CI/CD - Pipeline DevOps avec Terraform

on:
  push:
    branches:
      - main

env:
  # Configuration de base
  SONAR_HOST_URL: http://localhost:9000
  K3S_VERSION: v1.26.5+k3s1
  TERRAFORM_VERSION: 1.5.5
  NAMESPACE: microservice
  DOCKER_REGISTRY: docker.io
  NODE_VERSION: 20
  
  # Configuration Monitoring
  PROMETHEUS_PORT: 9090
  GRAFANA_PORT: 3000
  GRAFANA_ADMIN_PASSWORD: rabaa123
  GRAFANA_VERSION: 9.5.3
  
  # Configuration Email
  YOUR_EMAIL: elmbarkirabea@gmail.com
  EMAIL_FROM: "GitHub Actions <actions@github.com>"

jobs:
  setup-and-test:
    name: "1. Installation et Tests"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ›Žï¸ Checkout du code"
        uses: actions/checkout@v4.1.1

      - name: "âŽ” Configurer Node.js"
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ“¦ Installer les dÃ©pendances"
        run: npm ci

      - name: "ðŸ§ª Tests Unitaires"
        run: npm run test:unit
        env:
          NODE_ENV: test

      - name: "ðŸ”— Tests d'IntÃ©gration"
        run: npm run test:integration
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: testuser
          DB_PASSWORD: testpass
          NODE_ENV: test

      - name: "ðŸ› ï¸ Build de l'application"
        run: npm run build

  sonarqube-analysis:
    name: "2. Analyse SonarQube"
    needs: setup-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: "ðŸ›Žï¸ Checkout du code"
        uses: actions/checkout@v4.1.1
        with:
          fetch-depth: 0

      - name: "ðŸ³ DÃ©marrer SonarQube"
        run: |
          docker run -d \
            --name sonarqube \
            -p 9000:9000 \
            -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
            sonarqube:9.9.1-community
          timeout 300 bash -c 'while ! curl -sSf ${{ env.SONAR_HOST_URL }}/api/system/status | grep -q "\"status\":\"UP\""; do
            sleep 10
            echo "En attente du dÃ©marrage..."
          done'

      - name: "ðŸ”‘ GÃ©nÃ©rer token SonarQube"
        run: |
          SONAR_TOKEN=$(curl -sS -u admin:admin \
            -X POST "${{ env.SONAR_HOST_URL }}/api/user_tokens/generate" \
            -d "name=github-action-$(date +%s)" \
            | jq -r '.token')
          echo "SONAR_TOKEN=$SONAR_TOKEN" >> $GITHUB_ENV
          echo "::add-mask::$SONAR_TOKEN"

      - name: "ðŸ” ExÃ©cuter analyse SonarQube"
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=gestion-trajet-app
            -Dsonar.sources=src
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

      - name: "ðŸ§¹ Nettoyer SonarQube"
        if: always()
        run: docker rm -f sonarqube || true

  docker-deploy:
    name: "3. DÃ©ploiement Docker et Kubernetes"
    needs: sonarqube-analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ›Žï¸ Checkout du code"
        uses: actions/checkout@v4.1.1

      - name: "ðŸ” Login Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: "ðŸ—ï¸ Build Docker"
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:${{ github.sha }}
            ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/gestion-trajet:latest

      - name: "ðŸ“¦ Sauvegarder les outputs Terraform"
        id: save-outputs
        working-directory: infra
        run: |
          terraform init
          terraform apply -auto-approve
          terraform output -json > outputs.json
          echo "service_url=$(terraform output -raw service_url)" >> $GITHUB_OUTPUT
          
      - name: "ðŸ“¤ Upload Terraform outputs"
        uses: actions/upload-artifact@v3
        with:
          name: tf-outputs
          path: infra/outputs.json

      - name: "ðŸ–¥ï¸ Installer K3s"
        run: |
          curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=${{ env.K3S_VERSION }} sh -
          sudo chmod 644 /etc/rancher/k3s/k3s.yaml

      - name: "âš™ï¸ Configurer kubectl"
        run: |
          mkdir -p $HOME/.kube
          sudo cp /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
          sudo chown $(id -u):$(id -g) $HOME/.kube/config

      - name: "ðŸ” VÃ©rifier le dÃ©ploiement"
        run: |
          kubectl get pods,svc,deploy -n ${{ env.NAMESPACE }}
          echo "Service URL: ${{ steps.save-outputs.outputs.service_url }}"

  monitoring-deploy:
    name: "4. DÃ©ploiement Monitoring"
    needs: docker-deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: "ðŸ›Žï¸ Checkout du code"
        uses: actions/checkout@v4.1.1
    
      - name: "ðŸ“¦ Installer Docker Compose"
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version
    
      - name: "ðŸ§¹ Nettoyer l'environnement"
        working-directory: ./monitoring
        run: |
          docker-compose down -v --remove-orphans || true
          sudo rm -rf grafana-storage || true
          mkdir -p grafana-storage
          chmod -R 777 grafana-storage

      - name: "ðŸš€ DÃ©marrer les services"
        working-directory: ./monitoring
        env:
          GF_INSTALL_PLUGINS: ""
        run: |
          docker-compose up -d
          sleep 30

      - name: "â³ Attendre Grafana"
        working-directory: ./monitoring
        timeout-minutes: 20
        run: |
          echo "Attente du dÃ©marrage de Grafana..."
          start_time=$(date +%s)
          timeout=1200
          
          while :; do
            if ! docker-compose ps | grep grafana | grep -q "Up"; then
              echo "âŒ Le conteneur Grafana s'est arrÃªtÃ©"
              docker-compose logs grafana
              exit 1
            fi
            
            if curl -s http://localhost:3000/api/health | grep -q "\"database\":\"ok\""; then
              echo "âœ… Grafana prÃªt aprÃ¨s $(($(date +%s) - start_time)) secondes"
              break
            fi
            
            if [ $(($(date +%s) - start_time)) -ge $timeout ]; then
              echo "âŒ Timeout - Grafana n'a pas dÃ©marrÃ© aprÃ¨s 20 minutes"
              docker-compose logs grafana
              exit 1
            fi
            
            echo "En attente... ($(($(date +%s) - start_time))s)"
            sleep 10
          done

      - name: "ðŸ“ˆ Configurer Grafana"
        working-directory: ./monitoring
        run: |
          for attempt in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "http://localhost:3000/api/datasources" \
              -H "Content-Type: application/json" \
              -u "admin:${{ env.GRAFANA_ADMIN_PASSWORD }}" \
              -d '{
                "name":"Prometheus",
                "type":"prometheus",
                "url":"http://prometheus:9090",
                "access":"proxy",
                "basicAuth":false
              }')
            
            if [ "$response" -eq 200 ] || [ "$response" -eq 409 ]; then
              echo "âœ… Configuration rÃ©ussie"
              exit 0
            else
              echo "âš ï¸ Ã‰chec tentative $attempt (HTTP $response)"
              sleep 15
            fi
          done
          exit 1

  notify:
    name: "5. Notifications"
    needs: [docker-deploy, monitoring-deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: "ðŸ›Žï¸ Checkout du code"
        uses: actions/checkout@v4.1.1

      - name: "ðŸ“¥ Download Terraform outputs"
        uses: actions/download-artifact@v3
        with:
          name: tf-outputs
          path: tf-outputs

      - name: "ðŸŒ RÃ©cupÃ©rer l'URL"
        id: prod-url
        run: |
          SERVICE_URL=$(jq -r '.service_url.value' tf-outputs/outputs.json)
          echo "PROD_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "URL du service: $SERVICE_URL"

      - name: "ðŸ“§ Envoyer notification"
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          from: ${{ env.EMAIL_FROM }}
          to: ${{ env.YOUR_EMAIL }}
          subject: "DÃ©ploiement terminÃ© - ${{ github.repository }}"
          body: |
            Statut: ${{ job.status }}
            Commit: ${{ github.sha }}
            URL: ${{ steps.prod-url.outputs.PROD_URL }}
            Date: $(date)
          attachments: monitoring/report.md