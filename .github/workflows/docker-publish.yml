name: CI/CD - Docker Build & Deploy

on:
  push:
    branches:
      - main  # Le workflow s'exÃ©cutera lorsque des commits seront poussÃ©s sur la branche main

jobs:
  build-and-push:
    runs-on: self-hosted  # Utilise le self-hosted runner sur ta VM (local)

    steps:
      - name: ğŸ›ï¸ Checkout du code
        uses: actions/checkout@v3  # Cette action rÃ©cupÃ¨re le code de ton dÃ©pÃ´t GitHub

      # Connexion Ã  Docker Hub avec l'authentification sÃ©curisÃ©e
      - name: ğŸ”‘ Connexion Ã  Docker Hub
        run: echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: ğŸ”¨ Construire l'image Docker
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/gestion_trajet:latest .  # Construction de l'image Docker

      - name: ğŸš€ Pousser l'image sur Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/gestion_trajet:latest  # PoussÃ©e de l'image vers Docker Hub

  deploy:
    runs-on: self-hosted  # Utilisation du self-hosted runner pour dÃ©ployer sur ta VM locale
    needs: build-and-push  # Le job 'deploy' sera exÃ©cutÃ© aprÃ¨s le job 'build-and-push'

    steps:
      - name: ğŸ›ï¸ Checkout du code
        uses: actions/checkout@v3  # RÃ©cupÃ©ration du code

      - name: ğŸ”‘ Connexion Ã  Docker Hub
        run: echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin  # Connexion sÃ©curisÃ©e Ã  Docker Hub

      - name: ğŸš¢ ExÃ©cuter le conteneur Docker
        run: |
          docker pull ${{ secrets.DOCKER_USERNAME }}/gestion_trajet:latest  # RÃ©cupÃ¨re la derniÃ¨re image depuis Docker Hub
          docker rm -f mon-container || true  # Supprime l'ancien conteneur s'il existe dÃ©jÃ 
          docker run -d --name mon-container -p 80:80 ${{ secrets.DOCKER_USERNAME }}/gestion_trajet:latest  # ExÃ©cution du conteneur avec l'image tÃ©lÃ©chargÃ©e
